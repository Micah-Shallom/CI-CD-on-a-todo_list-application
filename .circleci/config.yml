version: 2.1
orbs: 
  versioning: kollex/versioning@1.0.0
description: "Define a VERSION and DOCKER_TAG based on the current git tag or branch name"

commands:
  define_version:
    description: Define env vars DOCKER_TAG and VERSION based on an optional git tag or the git branch name
    steps:
      - run:
          name: Define VERSION and DOCKER_TAG environment varriables
          command: |
            CIRCLE_BRANCH_CLEAN=$(echo ${CIRCLE_BRANCH} | sed "s;/;-;ig")

            if [ -n "${CIRCLE_TAG}" ]; then DOCKER_TAG=${CIRCLE_TAG}; else DOCKER_TAG="${CIRCLE_BRANCH_CLEAN}"; fi
            if [ -n "${CIRCLE_TAG}" ]; then VERSION=${CIRCLE_TAG}; else VERSION="${CIRCLE_BRANCH_CLEAN}@${CIRCLE_SHA1:0:6}"; fi

            echo "export VERSION=$VERSION" >> $BASH_ENV
            echo "export DOCKER_TAG=$DOCKER_TAG" >> $BASH_ENV

  print_version:
    description: Print the current VERSION
    steps:
      - run:
          name: Print version
          command: |
            echo "VERSION: $VERSION"

  print_docker_tag:
    description: Print the current Docker tag name
    steps:
      - run:
          name: Print Docker tag
          command: |
            echo "DOCKER_TAG: $DOCKER_TAG"

  create_version_file:
    description: Create a file which contains the current version
    parameters:
      version_file_path:
        type: string
        description: The path to the newly created version file
        default: ./VERSION
    steps:
      - run:
          name: Create version file
          command: |
            echo $VERSION > << parameters.version_file_path >>
      - run:
          name: Check version file
          command: |
            cat << parameters.version_file_path >>

jobs:
  create-version-file:
    docker:
      - image: circleci/python:3
    steps:
      - define_version
      - print_version
      - print_docker_tag
      - create_version_file

  print-version:
    docker:
      - image: circleci/python:3
    steps:
      - define_version
      - print_version
      - print_docker_tag

workflows:
  my-workflow:
    jobs:
      - create-version-file
      - print-version
