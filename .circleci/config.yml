version: 2.1

orbs: 
  node: circleci/node@5.0.2 

jobs:
  build-app:
    docker:
      - image: cimg/node:15.0.1
    steps:
      - checkout
      - restore_cache:
          keys: [application-build]
      - run:
          name: Building our application with node
          command: |
            npm install
      - save_cache:
          paths: [./node_modules]
          key: application-build
  audit-app:
    docker: 
      - image: cimg/node:15.0.1
    steps:  
      - checkout
      - restore_cache:  
          keys: [application-build]
      - run:
          name: job running security audit on frontend build
          command: |
            npm install
            npm audit fix --audit-level=critical --force
            npm audit --audit-level=critical
  deploy-frontend:
    docker:
    - image: cimg/node:15.0.1
    steps:
      - checkout
      - restore_cache:
          keys: [application-build]
      - run:
          name: checking docker version
          command: |
            docker --version





workflows:
  my_workflow:
    jobs:
      - build-app
      - audit-app
      - deploy-frontend:
          depends: [build-app, audit-app]
  